#!/usr/bin/env perl
#
# setup products for the build environment
# use product_deps and MRB_QUALS

use File::Basename;
use lib dirname($0);

use mrb_parse_deps;

use strict;
use warnings;

if( $#ARGV < 1 ) {
    my $errfl1 = "problem_report";
    open(ERR1, "> $errfl1") or die "Couldn't open $errfl1";
    print ERR1 "\n";
    print ERR1 "unsetenv_ CETPKG_NAME\n";
    print ERR1 "unsetenv_ CETPKG_VERSION\n";
    print ERR1 "unsetenv_ CETPKG_QUAL\n";
    print ERR1 "unsetenv_ CETPKG_TYPE\n";
    print ERR1 "unsetenv_ CETPKG_CC\n";
    print ERR1 "unsetenv_ CETPKG_CXX\n";
    print ERR1 "unsetenv_ CETPKG_FC\n";
    print ERR1 "echo \"ERROR: directory not specified\"\n";
    print ERR1 "echo \"USAGE: setup_products <input-directory> <build-directory>\"\n";
    print ERR1 "return 1\n";
    close(ERR1);
    print "$errfl1\n";
    exit 0;
}

my $sourcedir = $ARGV[0];

my $builddir = $ARGV[1];
# use this file for debugging
my $diagfl = $builddir."/diag_report";
open(my $dfh, "+> $diagfl") or die "Couldn't open $diagfl";

my $simple = "false";
for my $i ( 2 .. $#ARGV ) {
    if( $ARGV[$i] eq "simple" ) {
      $simple = "true";
    } else {
      print $dfh "setup_products debug info: ignoring $ARGV[$i]\n";
    }
}

my $mrb_project = $ENV{MRB_PROJECT};
my $mrb_project_version = $ENV{MRB_PROJECT_VERSION};
$setup_products::mrb_quals = sort_qual ( $ENV{MRB_QUALS} );
##print $dfh "setup_products debug info: mrb_quals is $setup_products::mrb_quals \n";

# determine the compiler based on mrb_quals
my $default_fc = ( $^O eq "darwin" ) ? "-" : "gfortran";
my $compiler;
if (!$compiler) {
  my @quals = split /:/, $setup_products::mrb_quals;
  if (grep /^(e|gcc)\d+$/, @quals) {
    $compiler = "gcc";
  } elsif (grep /^(i|icc)\d+$/, @quals) {
    $compiler = "icc";
  } else {
    $compiler = "cc"; # Native.
  }
}
my $compiler_table =
  {
   cc => { CC => "cc", CXX => "c++", FC => $default_fc },
   gcc => { CC => "gcc", CXX => "g++", FC => "gfortran" },
   icc => { CC => "icc", CXX => "icpc", FC => "ifort" },
  };

# determine build type from MRB_QUALS
if ( $simple eq "true" ) {
  $setup_products::dop = "";
  $setup_products::type = "simple";
} elsif ( $setup_products::mrb_quals eq "-nq-" ) {
  $simple = "true";
  $setup_products::dop = "";
  $setup_products::type = "simple";
} else {
  $setup_products::dop = "undefined";
  $setup_products::type = "undefined";
  my @qlist=split(/:/,$setup_products::mrb_quals);
  for my $i ( 0 .. $#qlist ) {
      #print $dfh "setup_products debug info: qualifier $i $qlist[$i]\n";
      if( $qlist[$i] eq "debug" ) {
	$setup_products::dop = "debug";
	$setup_products::type = "Debug";
      } elsif( $qlist[$i] eq "opt" ) {
	$setup_products::dop = "opt";
	$setup_products::type = "Opt";
      } elsif( $qlist[$i] eq "prof" ) {
	$setup_products::dop = "prof";
	$setup_products::type = "Prof";
      }
  }
  if ( $setup_products::dop eq "undefined" ) {
      my $errfl2 = "problem_report";
      open(ERR2, "> $errfl2") or die "Couldn't open $errfl2";
      print ERR2 "\n";
      print ERR2 "unsetenv_ CETPKG_NAME\n";
      print ERR2 "unsetenv_ CETPKG_VERSION\n";
      print ERR2 "unsetenv_ CETPKG_QUAL\n";
      print ERR2 "unsetenv_ CETPKG_TYPE\n";
      print ERR2 "unsetenv_ CETPKG_CC\n";
      print ERR2 "unsetenv_ CETPKG_CXX\n";
      print ERR2 "unsetenv_ CETPKG_FC\n";
      print ERR2 "echo \"ERROR: \"\n";
      print ERR2 "echo \"ERROR: build type is not declared\"\n";
      print ERR2 "echo \"ERROR: \"\n";
      print ERR2 "return 1\n";
      close(ERR2);
      print "$errfl2\n";
      exit 0;
  }
}

my $srcbase = basename($sourcedir);
my $inputdir;
if ( $srcbase eq "ups" ) {
    $inputdir = $sourcedir;
    ##print $dfh "setup_products debug info: have the old setup_for_development\n";
    my $errfl2 = "problem_report";
    open(ERR2, "> $errfl2") or die "Couldn't open $errfl2";
    print ERR2 "\n";
    print ERR2 "unsetenv_ CETPKG_NAME\n";
    print ERR2 "unsetenv_ CETPKG_VERSION\n";
    print ERR2 "unsetenv_ CETPKG_QUAL\n";
    print ERR2 "unsetenv_ CETPKG_TYPE\n";
    print ERR2 "unsetenv_ CETPKG_CC\n";
    print ERR2 "unsetenv_ CETPKG_CXX\n";
    print ERR2 "unsetenv_ CETPKG_FC\n";
    print ERR2 "echo \"ERROR: \"\n";
    print ERR2 "echo \"ERROR: you have an old copy of setup_for_development\"\n";
    print ERR2 "echo \"ERROR: please issue the following command\"\n";
    print ERR2 "echo \"ERROR: cp \$CETBUILDTOOLS_DIR/templates/setup_for_development.template $inputdir/setup_for_development\"\n";
    print ERR2 "echo \"ERROR: \"\n";
    print ERR2 "return 1\n";
    close(ERR2);
    print "$errfl2\n";
    exit 0;
} else {
    $inputdir = $sourcedir."/ups";
}
#print $dfh "setup_products debug info: source dir is $sourcedir\n";

my $tmpfl = $builddir."/".$mrb_project."-".$mrb_project_version;
##print $dfh "setup_products debug info: opening $tmpfl for $mrb_project $mrb_project_version\n";
open(my $tfh, "+> $tmpfl") or die "Couldn't open $tmpfl";

print $tfh "setenv UPS_OVERRIDE -B\n";
print $tfh "setenv CETPKG_NAME $mrb_project\n";
print $tfh "setenv CETPKG_VERSION $mrb_project_version\n";
if ( $simple eq "true" ) {
  print $tfh "unsetenv_ CETPKG_QUAL\n";
  print $tfh "unsetenv_ CETPKG_TYPE\n";
  print $tfh "unsetenv_ CETPKG_CC\n";
  print $tfh "unsetenv_ CETPKG_CXX\n";
  print $tfh "unsetenv_ CETPKG_FC\n";
} else {
  print $tfh "setenv CETPKG_QUAL $setup_products::mrb_quals\n";
  print $tfh "setenv CETPKG_TYPE $setup_products::type\n";
  print $tfh "setenv CETPKG_CC $compiler_table->{$compiler}->{CC}\n";
  print $tfh "setenv CETPKG_CXX $compiler_table->{$compiler}->{CXX}\n";
  print $tfh "setenv CETPKG_FC $compiler_table->{$compiler}->{FC}\n";
}

# have to find the list of packages to traverse
my $cmakefile=$sourcedir."/CMakeLists.txt";
@setup_products::package_list = get_package_list( $cmakefile, $dfh );
##print $dfh "DIAGNOSTICS: packages to check: $#package_list @package_list\n";
if ( $#setup_products::package_list < 0 ) {
  print $dfh "DIAGNOSTICS: there are no packages in $sourcedir\n";
  print $dfh "DIAGNOSTICS: nothing to build\n";
  print "$tmpfl\n";
  exit 0;
}

my $use_cetbver="v0_00_00";
my @cetbver;
my @productnames;
my @productversn;
for my $i ( 0 .. $#setup_products::package_list ) {
  my $pkg=$setup_products::package_list[$i];
  my $pfile=$sourcedir."/".$pkg."/ups/product_deps";
  ##print $dfh "setup_products debug info: checking $pfile for $pkg \n";
  ($productnames[$i], $productversn[$i]) = get_product_name( $pfile, $dfh );
  $cetbver[$i] = find_cetbuildtools( $pfile );
  ##print $dfh "setup_products debug info: cetbuildtools $cetbver[$i]\n";
  $use_cetbver = compare_versions( $use_cetbver, $cetbver[$i] );
}
print $tfh "setup -B cetbuildtools $use_cetbver\n";
print $tfh "test \"\$?\" = 0 || set_ setup_fail=\"true\"\n"; 
print $tfh "setup -B cetpkgsupport \n";
print $tfh "test \"\$?\" = 0 || set_ setup_fail=\"true\"\n"; 
@setup_list=( "cetbuildtools", "cetpkgsupport" );

# now check for an old build directory 
my $old_build_dir=$ENV{OLD_MRB_BUILDDIR};
if ( $old_build_dir ) {
  ##print $dfh "setup_products debug info: found old build directory $old_build_dir\n";
  print $tfh "setenv  PATH \`dropit -p \${PATH} \'${old_build_dir}\'`\n";
  print $tfh "setenv  LD_LIBRARY_PATH \`dropit -p \${LD_LIBRARY_PATH} \'${old_build_dir}\'`\n";
  print $tfh "setenv  DYLD_LIBRARY_PATH \`dropit -p \${DYLD_LIBRARY_PATH} \'${old_build_dir}\'\`\n";
}
##print $dfh "setup_products debug info: product names @productnames\n";
##print $dfh "setup_products debug info: product versions @productversn\n";

print $tfh "# setup products\n";
for my $i ( 0 .. $#setup_products::package_list ) {
  my $pkg=$setup_products::package_list[$i];
  $setup_products::product = "";
  $setup_products::version = "";
  ##print $dfh "setup_products debug info: calling product_setup_loop for $pkg $setup_products::dop \n";
  ($setup_products::product, $setup_products::version) = product_setup_loop( $sourcedir, $pkg, $simple, $builddir, $dfh, $tfh );

  if ( $setup_products::product ne $productnames[$i] ) {
     print $dfh "ERROR: product names do not match: $setup_products::product vs $productnames[$i]\n";
     exit 1;
  }
  if ( $setup_products::version ne $productversn[$i] ) {
     print $dfh "ERROR: version names do not match: $setup_products::version vs $productversn[$i]\n";
     exit 1;
  }
}

my $onlyForBuild="cetbuildtools;";
my $cetfl = cetpkg_info_file( $mrb_project, 
                              $mrb_project_version, 
			      $mrb_project_version, 
			      $setup_products::mrb_quals, 
			      $setup_products::type, 
			      $sourcedir, 
			      $builddir,
                              $compiler_table->{$compiler}->{CC},
                              $compiler_table->{$compiler}->{CXX},
                              $compiler_table->{$compiler}->{FC},
			      $onlyForBuild
			   );

# cleanup
close($tfh);
close($dfh);
print "$tmpfl\n";

exit 0;
